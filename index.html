<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ï¼“å¹´ ãŸã—ç®—ãƒ»ã²ãç®— ç­†ç®—ãƒã‚¹ã‚¿ãƒ¼</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Nunito:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #f0fdf4; /* green-50 */
            background-image: radial-gradient(#dcfce7 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .number-font {
            font-family: 'Nunito', sans-serif;
        }
        
        /* æ•™ç§‘æ›¸ä½“æŒ‡å®š */
        .text-kyokasho {
            font-family: 'Kiwi Maru', serif;
        }

        /* ãƒ«ãƒ“ */
        ruby { ruby-position: over; }
        rt { font-size: 0.6em; color: #64748b; }

        /* --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
        .bubble-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            /* é‡è¦: ãƒœã‚¿ãƒ³ã¯å¸¸ã«æ“ä½œå¯èƒ½ã« */
            pointer-events: auto !important;
            z-index: 100 !important;
        }
        .bubble-btn:active { transform: scale(0.95); }

        /* å¹ãå‡ºã— */
        .speech-bubble {
            position: relative;
            background: #ffffff;
            border: 3px solid #86efac;
            border-radius: 1.5rem;
            padding: 12px 16px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%; bottom: -12px; transform: translateX(-50%);
            border-width: 12px 10px 0; border-style: solid;
            border-color: #86efac transparent transparent;
        }

        /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        .float-anim { animation: floating 3s ease-in-out infinite; }
        @keyframes floating {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease-in-out; }

        /* æ­£è§£ã®èµ¤ä¸¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes drawCircle {
            0% { stroke-dasharray: 0, 1000; opacity: 0; transform: scale(0.5); }
            100% { stroke-dasharray: 1000, 0; opacity: 1; transform: scale(1); }
        }
        .circle-anim {
            animation: drawCircle 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            transform-origin: center;
        }

        /* ã‚ªãƒ¼ãƒ© */
        @keyframes shine-spin {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); opacity: 0.8; }
        }
        .legend-aura {
            animation: shine-spin 4s linear infinite;
            background: radial-gradient(circle, rgba(253,224,71,0.6) 0%, rgba(234,179,8,0.3) 60%, rgba(255,255,255,0) 80%);
            box-shadow: 0 0 30px 10px rgba(250, 204, 21, 0.4);
        }

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ§‹æˆ --- */
        /* é‡è¦: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢é€£ã¯å…¨ã¦ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–ã—ã¦èƒŒé¢ã«å›ã™ */
        .char-wrapper, .char-wrapper *, .accessory, .aura-bg, .red-cape { 
            pointer-events: none !important; 
        }
        
        .char-wrapper { position: relative; display: inline-block; z-index: 10; }
        .char-body { position: relative; z-index: 10; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1)); }
        .accessory {
            position: absolute; z-index: 20;
            display: flex; align-items: center; justify-content: center;
        }
        .aura-bg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150%; height: 150%; border-radius: 50%; z-index: -10;
        }
        .red-cape {
            position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%);
            width: 140%; height: 90%; background: #EF4444; border-radius: 40% 40% 10% 10%;
            z-index: -5; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* --- æ–¹çœ¼ã‚°ãƒªãƒƒãƒ‰è¨­å®š --- */
        #hissan-wrapper {
            position: relative;
            width: fit-content;
            max-width: 100%;
            margin: 0 auto;
            padding: 4px;
            display: flex;
            justify-content: center;
        }

        .hissan-grid {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            max-width: 500px; 
            background-color: white;
            border: 3px solid #93c5fd;
            background-image: 
                linear-gradient(#bfdbfe 2px, transparent 2px), 
                linear-gradient(90deg, #bfdbfe 2px, transparent 2px);
        }

        .grid-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Kiwi Maru', serif;
            font-size: 3.2rem;
            font-weight: 500;
            line-height: 1;
            color: #1e293b;
            position: relative;
            aspect-ratio: 1 / 1;
            padding-bottom: 0.1em;
            overflow: visible;
        }

        /* ã²ã£ç®—ã®æ¨ªç·š */
        .hissan-line::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 4px;
            background-color: #334155;
            z-index: 10;
        }

        /* --- ãƒ¡ãƒ¢ã‚­ãƒ£ãƒ³ãƒã‚¹ --- */
        canvas#memo-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50;
            touch-action: none;
            cursor: crosshair;
            pointer-events: none;
        }
        canvas#memo-canvas.active {
            pointer-events: auto;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            border: 2px dashed #86efac;
        }

        /* --- ãƒ†ãƒ³ã‚­ãƒ¼ --- */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            width: 100%;
            max-width: 280px;
            padding: 0.2rem;
            margin: 0 auto;
        }
        .num-key {
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 0.8rem;
            padding: 0.5rem 0;
            font-family: 'Nunito', sans-serif;
            font-size: 1.4rem;
            font-weight: bold;
            color: #475569;
            box-shadow: 0 2px 0 #cbd5e1;
            transition: all 0.1s;
            touch-action: manipulation;
            pointer-events: auto !important; /* å¼·åˆ¶æœ‰åŠ¹åŒ– */
            z-index: 100;
        }
        .num-key:active {
            transform: translateY(2px);
            box-shadow: none;
            background-color: #f1f5f9;
        }
        .num-key.enter-key {
            background-color: #86efac;
            color: #166534;
            border-color: #4ade80;
            box-shadow: 0 2px 0 #22c55e;
            font-size: 1.1rem;
            font-family: 'Kiwi Maru', serif;
        }
        .num-key.enter-key:active {
            background-color: #4ade80;
            box-shadow: none;
        }
        .num-key.del-key {
            color: #ef4444;
            background-color: #fef2f2;
            border-color: #fecaca;
            box-shadow: 0 2px 0 #fca5a5;
            font-size: 1.1rem;
            font-family: 'Kiwi Maru', serif;
        }

        /* æ­£è§£ã®èµ¤ä¸¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #correct-mark {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 100;
        }

        /* ãƒ¬ãƒ™ãƒ«é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å¼·åˆ¶æœ€å‰é¢åŒ– */
        select#level-select {
            pointer-events: auto !important;
            z-index: 200 !important; /* ã‚­ãƒ£ãƒ©(10)ã‚„ãƒœã‚¿ãƒ³(100)ã‚ˆã‚Šä¸Š */
            position: relative;
            background-color: #fff; /* èƒŒæ™¯è‰²ã‚’ç¢ºä¿ã—ã¦é€éé˜²æ­¢ */
            -webkit-appearance: menulist-button; /* ã‚¹ãƒãƒ›ã§ã®è¦‹ãŸç›®å®‰å®š */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="bg-white/95 backdrop-blur-sm p-3 rounded-[2rem] shadow-2xl border-4 border-green-200 w-full h-[95vh] max-h-[800px] max-w-md flex flex-col relative overflow-hidden">

        <!-- ====================
             ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
        ==================== -->
        <div id="start-screen" class="absolute inset-0 z-[50] bg-white flex flex-col items-center justify-between p-4 pb-8 text-center rounded-[2rem]">
            <div class="mt-4 w-full flex flex-col items-center">
                <span class="inline-block bg-green-500 text-white text-sm font-bold px-4 py-1.5 rounded-full mb-3 shadow-md tracking-wider">
                    ç®—æ•°ãƒ‰ãƒªãƒ«
                </span>
                <h1 class="text-3xl font-bold text-green-700 tracking-wider leading-snug drop-shadow-sm mb-1">
                    ï¼“å¹´ã€€ãŸã—ç®—ãƒ»ã²ãç®—<br>ç­†ç®—ãƒã‚¹ã‚¿ãƒ¼
                </h1>
                <p class="text-gray-400 font-bold text-xs mt-1">ã„ã£ã—ã‚‡ã«å‹‰å¼·ã™ã‚‹å‹ã ã¡ã‚’é¸ã¼ã†ï¼</p>
            </div>

            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ (z-indexã‚’é«˜ãã—ã¦æ“ä½œå¯èƒ½ã«) -->
            <div class="flex gap-4 my-2 relative z-50">
                <button class="bubble-btn w-16 h-16 bg-blue-50 rounded-2xl text-3xl flex items-center justify-center border-2 border-blue-100 hover:border-blue-300 ring-offset-2 focus:ring-2 ring-blue-200" onclick="selectChar('ğŸ¥', 'ãƒ’ãƒ¨ã‚³')">ğŸ¥</button>
                <button class="bubble-btn w-16 h-16 bg-yellow-50 rounded-2xl text-3xl flex items-center justify-center border-2 border-yellow-100 hover:border-yellow-300 ring-offset-2 focus:ring-2 ring-yellow-200" onclick="selectChar('ğŸ¦‰', 'ãƒ•ã‚¯ãƒ­ã‚¦')">ğŸ¦‰</button>
                <button class="bubble-btn w-16 h-16 bg-orange-50 rounded-2xl text-3xl flex items-center justify-center border-2 border-orange-100 hover:border-orange-300 ring-offset-2 focus:ring-2 ring-orange-200" onclick="selectChar('ğŸ§¸', 'ã‚¯ãƒã•ã‚“')">ğŸ§¸</button>
            </div>

            <div class="flex flex-col items-center w-full flex-grow justify-center relative">
                <!-- å¹ãå‡ºã— -->
                <div class="speech-bubble mb-6 w-64 min-h-[60px] flex items-center justify-center z-20 pointer-events-none">
                    <p id="start-char-talk" class="text-gray-700 font-bold text-sm leading-snug">ç­†ç®—ãªã‚‰ã¾ã‹ã›ã¦ï¼</p>
                </div>
                
                <!-- ã‚­ãƒ£ãƒ©è¡¨ç¤º (pointer-events-noneã§èƒŒé¢ã®è¦ç´ ã‚’æ“ä½œå¯èƒ½ã«) -->
                <div class="char-wrapper text-6xl sm:text-8xl float-anim mb-8 relative z-10" id="start-char-view">
                    <div id="start-aura"></div>
                    <span id="preview-emoji" class="char-body">ğŸ¥</span>
                    <div id="start-accessories"></div>
                </div>
                
                <div class="flex flex-col items-center gap-4 w-full px-4 relative z-40">
                    <div id="title-label" class="text-lg font-bold text-green-600 bg-green-50 px-6 py-1.5 rounded-full border border-green-200 shadow-sm">
                        ã‹ã‘ã ã—ãƒ’ãƒ¨ã‚³
                    </div>
                    
                    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠ (z-indexã‚’æ¥µç«¯ã«é«˜ãè¨­å®š) -->
                    <div class="flex items-center gap-3 w-full justify-center bg-gray-50 p-2 rounded-xl relative z-50">
                        <label class="text-xs font-bold text-gray-500 whitespace-nowrap">ãƒ¬ãƒ™ãƒ«:</label>
                        <select id="level-select" onchange="changeLevel(this.value)" class="flex-grow bg-white px-4 py-2 rounded-lg text-gray-700 font-bold text-sm border-2 border-gray-200 outline-none focus:border-green-400 cursor-pointer w-full">
                            <!-- JSç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="flex flex-col items-center gap-1 w-full max-w-[240px]">
                        <div class="flex justify-between w-full text-[10px] font-bold text-gray-400 px-1">
                            <span>ã“ã‚Œã¾ã§ã®åˆè¨ˆ</span>
                            <span><span id="total-solved-display" class="text-lg text-green-600">0</span>å• æ­£è§£</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                            <div id="progress-fill" class="h-full bg-gradient-to-r from-green-300 to-green-500 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="bubble-btn w-full h-16 bg-gradient-to-r from-green-400 to-teal-500 text-white text-2xl font-bold rounded-2xl shadow-lg shadow-green-200/50 mt-2 flex items-center justify-center gap-2 relative z-50" onclick="startGame()">
                <span class="text-3xl">â–¶</span> ã‚¹ã‚¿ãƒ¼ãƒˆï¼
            </button>
        </div>

        <!-- ====================
             ã‚²ãƒ¼ãƒ ç”»é¢ (ç­†ç®—)
        ==================== -->
        <div id="game-ui" class="hidden h-full flex flex-col justify-between relative">
            
            <!-- æ­£è§£ã®èµ¤ä¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
            <div id="correct-mark" class="hidden">
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex items-center justify-between mb-2 shrink-0 z-30 pt-1 px-1">
                <button onclick="backToStart()" class="bubble-btn flex items-center gap-1 text-gray-500 text-xs font-bold hover:text-green-600 px-3 py-2 rounded-xl hover:bg-gray-50 transition">
                    <span>ğŸ </span> æˆ»ã‚‹
                </button>
                
                <!-- ä¸­å¤®: ãƒ¬ãƒ™ãƒ«æƒ…å ± -->
                <div class="flex gap-1">
                    <div class="bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold text-xs border border-green-200 shadow-sm flex items-center">
                        Lv.<span id="display-level" class="text-base ml-0.5">1</span>
                    </div>
                    <div class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold text-xs border border-yellow-200 shadow-sm flex items-center">
                        æ®‹<span id="display-remain" class="text-base ml-0.5">10</span>
                    </div>
                </div>

                <!-- å³å´: ãƒ¡ãƒ¢æ“ä½œ -->
                <div class="flex gap-2">
                    <button onclick="clearMemo()" id="header-clear-btn" class="hidden bubble-btn bg-gray-100 text-gray-600 text-xs font-bold px-3 py-2 rounded-full border border-gray-300 shadow-sm hover:bg-gray-200 transition">
                        ğŸ—‘ï¸
                    </button>
                    <button onclick="toggleMemo()" id="memo-btn" class="bubble-btn flex items-center gap-1 bg-blue-100 text-blue-600 text-xs font-bold px-4 py-2 rounded-full border border-blue-200 shadow-sm hover:bg-blue-200 transition">
                        <span>âœï¸</span> ãƒ¡ãƒ¢
                    </button>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒ©è¡¨ç¤º -->
            <div class="flex items-center justify-center -mt-2 mb-0 z-20 pointer-events-none h-16">
                 <div class="char-wrapper text-5xl" id="game-char-view">
                    <div id="game-aura"></div>
                    <span id="game-char" class="char-body">ğŸ¥</span>
                    <div id="game-accessories"></div>
                </div>
            </div>

            <!-- å•é¡Œã®ç¨®é¡ãƒ©ãƒ™ãƒ« -->
            <div class="flex justify-center w-full mb-1">
                <span id="problem-type-label" class="bg-indigo-100 text-indigo-700 text-xs font-bold px-4 py-1 rounded-full border border-indigo-200">
                    2ã‘ãŸ ï¼‹ 2ã‘ãŸ
                </span>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="flex-grow flex flex-col items-center relative z-10 overflow-y-auto">
                
                <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="w-full flex justify-center items-center mb-1 px-1 py-2">
                    <div id="hissan-wrapper">
                        <div id="mathContainer">
                            <!-- ã“ã“ã«ã‚°ãƒªãƒƒãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ -->
                        </div>
                        <!-- ãƒ¡ãƒ¢ç”¨Canvas -->
                        <canvas id="memo-canvas"></canvas>
                    </div>
                </div>

                <!-- ç­”ãˆè¡¨ç¤º & ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ -->
                <div class="w-full max-w-[280px] flex flex-col items-center gap-2 mb-1">
                    
                    <!-- å…¥åŠ›å€¤è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
                    <div id="input-display" class="w-full h-20 bg-white border-4 border-green-300 rounded-2xl flex items-center justify-center text-5xl font-bold text-slate-700 shadow-inner text-kyokasho tracking-widest mt-1">
                        
                    </div>

                    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
                    <div id="feedbackArea" class="h-5 w-full flex items-center justify-center text-center">
                        <p class="text-slate-500 text-xs font-bold">ç­”ãˆã‚’å…¥åŠ›ã—ã¦ã­</p>
                    </div>
                </div>

                <!-- ãƒ†ãƒ³ã‚­ãƒ¼ -->
                <div class="numpad-grid">
                    <button class="num-key" onclick="inputNum('7')">7</button>
                    <button class="num-key" onclick="inputNum('8')">8</button>
                    <button class="num-key" onclick="inputNum('9')">9</button>
                    
                    <button class="num-key" onclick="inputNum('4')">4</button>
                    <button class="num-key" onclick="inputNum('5')">5</button>
                    <button class="num-key" onclick="inputNum('6')">6</button>
                    
                    <button class="num-key" onclick="inputNum('1')">1</button>
                    <button class="num-key" onclick="inputNum('2')">2</button>
                    <button class="num-key" onclick="inputNum('3')">3</button>
                    
                    <button class="num-key" onclick="inputNum('0')">0</button>
                    <button class="num-key del-key" onclick="inputNum('BS')">ã‘ã™</button>
                    <button class="num-key enter-key" onclick="checkAnswer()">OK</button>
                </div>

                <div class="h-1"></div>
            </div>
        </div>

        <!-- ãƒ­ãƒƒã‚¯é€šçŸ¥ -->
        <div id="lock-modal" class="hidden fixed inset-0 z-[200] bg-black/40 flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-[280px] animate-pop">
                <div class="text-5xl mb-4">ğŸ”’</div>
                <p id="lock-message" class="text-gray-700 font-bold mb-6 text-lg">
                    å‰ã®ãƒ¬ãƒ™ãƒ«ã‚’<br>ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼
                </p>
                <button onclick="closeLockModal()" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg active:scale-95">ã‚ã‹ã£ãŸï¼</button>
            </div>
        </div>

    </div>

    <script>
        // --- çŠ¶æ…‹ç®¡ç† ---
        const APP_ID = 'hissan_master_final_v22_fix_all'; 
        const MAX_LEVEL = 10;

        let audioCtx = null;

        let state = {
            charEmoji: 'ğŸ¥', 
            charName: 'ãƒ’ãƒ¨ã‚³',
            level: 1,
            maxUnlockedLevel: 1,
            totalSolved: 0,
            solvedInLevel: 0,
            currentA: 0,
            currentB: 0,
            isAddition: true,
            mistakeCount: 0,
            isMemoMode: false,
            gridCols: 3,
            userInput: ""
        };

        // --- éŸ³å£°åˆæˆ ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playDing() {
            initAudio();
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1318, t); // E6
            osc.frequency.setValueAtTime(1046, t + 0.15); // C6
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t);
            osc.stop(t + 0.6);
        }

        function playBuzzer() {
            initAudio();
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(100, t + 0.3);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0.001, t + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t);
            osc.stop(t + 0.3);
        }

        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– ---
        function save() {
            localStorage.setItem(APP_ID, JSON.stringify({
                level: state.level,
                maxUnlockedLevel: state.maxUnlockedLevel,
                charEmoji: state.charEmoji,
                charName: state.charName,
                totalSolved: state.totalSolved,
                solvedInLevel: state.solvedInLevel
            }));
        }

        function load() {
            try {
                const data = localStorage.getItem(APP_ID);
                if (data) {
                    const p = JSON.parse(data);
                    state.level = p.level || 1;
                    state.maxUnlockedLevel = p.maxUnlockedLevel || 1;
                    state.charEmoji = p.charEmoji || 'ğŸ¥';
                    state.charName = p.charName || 'ãƒ’ãƒ¨ã‚³';
                    state.totalSolved = p.totalSolved || 0;
                    state.solvedInLevel = p.solvedInLevel || 0;
                }
            } catch (e) { console.warn(e); }
            
            // â˜…è¨­å®šï¼šLv5ã¾ã§è§£æ”¾ï¼ˆLv6ä»¥ä¸Šã¯ãƒ­ãƒƒã‚¯ï¼‰
            if (state.maxUnlockedLevel < 5) {
                state.maxUnlockedLevel = 5;
            }
            
            // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ãŒãƒ­ãƒƒã‚¯ç¯„å›²ãªã‚‰Lv5ã«æˆ»ã™
            if (state.level > state.maxUnlockedLevel) {
                state.level = state.maxUnlockedLevel;
            }

            initLevelSelect();
            updateTitleAndPreview();
        }

        // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ & ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ ãƒ­ã‚¸ãƒƒã‚¯ ---
        const charOffsets = {
            'ğŸ¥': { hatY: { start: 0, game: 4 }, chestY: { start: 15, game: 12 } }, 
            'ğŸ¦‰': { hatY: { start: -2, game: 0 }, chestY: { start: 14, game: 10 } },
            'ğŸ§¸': { hatY: { start: -8, game: -4 }, chestY: { start: 8, game: 4 } }
        };

        function updateAccessories(currentLevel) {
            const startAcc = document.getElementById('start-accessories');
            const gameAcc = document.getElementById('game-accessories');
            if(!startAcc || !gameAcc) return;
            startAcc.innerHTML = ''; gameAcc.innerHTML = '';
            
            const startAura = document.getElementById('start-aura');
            const gameAura = document.getElementById('game-aura');
            
            const lv = currentLevel || state.level;
            
            // ã‚ªãƒ¼ãƒ©ã®è‰²è¨­å®š (Lv5=éŠ€, Lv6ä»¥ä¸Š=é‡‘)
            let auraClass = "";
            if (lv >= 10) auraClass = "aura-bg legend-aura";
            else if (lv >= 6) auraClass = "aura-bg bg-yellow-200 opacity-60"; // é‡‘
            else if (lv === 5) auraClass = "aura-bg bg-slate-300 opacity-60"; // éŠ€
            else if (lv >= 4) auraClass = "aura-bg bg-orange-200 opacity-50"; // éŠ…
            
            if(startAura) startAura.className = auraClass;
            if(gameAura) gameAura.className = auraClass;

            const offsets = charOffsets[state.charEmoji] || charOffsets['ğŸ¥'];
            
            const configs = {
                1: { emoji: 'ğŸ”°', start: `bottom:${offsets.chestY.start}px; left:50%; transform:translateX(-50%); font-size:1.5rem;`, game: `bottom:${offsets.chestY.game}px; left:50%; transform:translateX(-50%); font-size:0.9rem;` }, 
                2: { emoji: 'ğŸ§¢', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.6rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:0.9rem;` }, 
                3: { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                4: { multi: [
                    { emoji: 'ğŸ¥‰', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                ]},
                5: { multi: [
                    { emoji: 'ğŸ¥ˆ', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                ]},
                6: { multi: [
                    { emoji: 'ğŸ¥‡', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                ]},
                7: { multi: [
                    { emoji: 'ğŸŒŸ', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸª„', start: 'top:45px; right:-20px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:22px; right:-10px; font-size:1.2rem; transform: rotate(15deg);' },
                    { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                ]},
                8: { multi: [
                    { emoji: 'ğŸ–ï¸', start: `bottom:${offsets.chestY.start - 10}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 5}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸª„', start: 'top:45px; right:-20px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:22px; right:-10px; font-size:1.2rem; transform: rotate(15deg);' },
                    { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                ]},
                9: { multi: [
                    { emoji: 'ğŸ‘‘', start: `top:${offsets.hatY.start - 4}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game - 2}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸ’', start: `bottom:${offsets.chestY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸª„', start: 'top:45px; right:-20px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:22px; right:-10px; font-size:1.2rem; transform: rotate(15deg);' }
                ]},
                10: { multi: [
                    { emoji: 'ğŸ‘‘', start: `top:${offsets.hatY.start - 4}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game - 2}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸ’', start: `bottom:${offsets.chestY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, 
                    { emoji: 'ğŸª„', start: 'top:45px; right:-20px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:22px; right:-10px; font-size:1.2rem; transform: rotate(15deg);' }, 
                    { type: 'css', className: 'red-cape' }
                ]}
            };

            const config = configs[currentLevel || state.level] || (currentLevel > 10 ? configs[10] : null);
            if (!config) return;

            const createEl = (item, style) => {
                const div = document.createElement('div');
                if (item.type === 'css') {
                    div.className = item.className;
                } else {
                    div.className = 'accessory';
                    div.style = style;
                    div.innerText = item.emoji;
                }
                return div;
            };

            if (config.multi) {
                config.multi.forEach(c => {
                    if (c.type === 'css') {
                        startAcc.appendChild(createEl(c, null));
                        gameAcc.appendChild(createEl(c, null).cloneNode(true));
                    } else {
                        startAcc.appendChild(createEl({emoji:c.emoji}, c.start));
                        gameAcc.appendChild(createEl({emoji:c.emoji}, c.game));
                    }
                });
            } else if (config.emoji) {
                startAcc.appendChild(createEl({emoji:config.emoji}, config.start));
                gameAcc.appendChild(createEl({emoji:config.emoji}, config.game));
            }
        }

        function getLevelTitle(lv) {
            const titles = {
                1: "ã‹ã‘ã ã—", 2: "è¦‹ç¿’ã„", 3: "è¨ˆç®—åšå£«", 4: "éŠ…ã®ç­†ç®—å¸«",
                5: "éŠ€ã®ç­†ç®—å¸«", 6: "é‡‘ã®ç­†ç®—å¸«", 7: "é»„é‡‘ã®è³¢è€…",
                8: "ç­†ç®—ãƒã‚¹ã‚¿ãƒ¼", 9: "å¤©æ‰ç­†ç®—å¸«", 10: "ä¼èª¬ã®ç­†ç®—ç‹"
            };
            return titles[lv] || "ã‹ã‘ã ã—";
        }

        function updateTitleAndPreview() {
            document.getElementById('preview-emoji').innerText = state.charEmoji;
            document.getElementById('game-char').innerText = state.charEmoji;
            
            const titleText = getLevelTitle(state.level) + " " + state.charName;
            const titleEl = document.getElementById('title-label');
            titleEl.innerText = titleText;
            
            // ãƒãƒŠãƒ¼ã®è‰²è¨­å®š (Lv5=éŠ€, Lv6ä»¥ä¸Š=é‡‘)
            let titleClass = "text-lg font-bold px-6 py-1.5 rounded-full border shadow-sm ";
            if (state.level >= 6) {
                // é‡‘
                titleClass += "text-yellow-900 bg-yellow-300 border-yellow-500";
            } else if (state.level === 5) {
                // éŠ€
                titleClass += "text-slate-700 bg-slate-200 border-slate-400";
            } else if (state.level === 4) {
                // éŠ… (ã¤ã„ã§ã«è¨­å®š)
                titleClass += "text-orange-900 bg-orange-200 border-orange-400";
            } else {
                // é€šå¸¸ (ç·‘)
                titleClass += "text-green-600 bg-green-50 border-green-200";
            }
            titleEl.className = titleClass;

            document.getElementById('level-select').value = state.level;
            document.getElementById('total-solved-display').innerText = state.totalSolved;
            
            const progress = Math.min(100, (state.totalSolved / 100) * 100);
            document.getElementById('progress-fill').style.width = `${progress}%`;
            
            updateAccessories(state.level);
        }

        function initLevelSelect() {
            const select = document.getElementById('level-select');
            select.innerHTML = '';
            
            const levelDescriptions = [
                "2ã‘ãŸï¼‹2ã‘ãŸ (ãã‚Šä¸ŠãŒã‚Šãªã—)",
                "2ã‘ãŸï¼2ã‘ãŸ (ãã‚Šä¸‹ãŒã‚Šãªã—)",
                "2ã‘ãŸï¼‹2ã‘ãŸ (ãã‚Šä¸ŠãŒã‚Šã‚ã‚Š)",
                "2ã‘ãŸï¼2ã‘ãŸ (ãã‚Šä¸‹ãŒã‚Šã‚ã‚Š)",
                "3ã‘ãŸã®ãŸã—ç®—",
                "3ã‘ãŸã®ã²ãç®—",
                "3ã‘ãŸï¼‹3ã‘ãŸ",
                "3ã‘ãŸï¼3ã‘ãŸ",
                "3ã‘ãŸã²ãç®— (é›£)",
                "4ã‘ãŸã®è¨ˆç®—"
            ];

            for(let i = 1; i <= MAX_LEVEL; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${i}ï¼š${levelDescriptions[i-1]}`;
                if (i > state.maxUnlockedLevel) opt.innerText += " ğŸ”’";
                select.appendChild(opt);
            }
        }

        function changeLevel(val) {
            const newLv = parseInt(val);
            if (newLv > state.maxUnlockedLevel) {
                document.getElementById('lock-modal').classList.remove('hidden');
                document.getElementById('lock-message').innerHTML = `Lv.${state.maxUnlockedLevel}ã‚’<br>ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼`;
                document.getElementById('level-select').value = state.level;
                return;
            }
            state.level = newLv;
            state.solvedInLevel = 0;
            save();
            updateTitleAndPreview();
        }

        function selectChar(emoji, name) {
            state.charEmoji = emoji;
            state.charName = name;
            save();
            updateTitleAndPreview();
        }

        function closeLockModal() {
            document.getElementById('lock-modal').classList.add('hidden');
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            generateProblem();
        }

        function backToStart() {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('hidden');
            save();
            updateTitleAndPreview();
            if(state.isMemoMode) toggleMemo();
        }

        // --- ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ› ---
        function inputNum(val) {
            if (val === 'BS') {
                state.userInput = state.userInput.slice(0, -1);
            } else {
                if (state.userInput.length < 6) { // æœ€å¤§æ–‡å­—æ•°åˆ¶é™
                    state.userInput += val;
                }
            }
            updateInputDisplay();
        }

        function updateInputDisplay() {
            document.getElementById('input-display').innerText = state.userInput;
        }

        // --- å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function generateProblem() {
            const lv = state.level;
            
            // å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©
            if (lv === 1) { state.isAddition = true; setNums(11,88, 11,88); } 
            else if (lv === 2) { state.isAddition = false; setNums(20,99, 10,90); }
            else if (lv === 3) { state.isAddition = true; setNums(15,85, 15,85); }
            else if (lv === 4) { state.isAddition = false; setNums(20,95, 11,94); }
            else if (lv === 5) { state.isAddition = true; state.currentA=r(100,500); state.currentB=r(50,400); }
            else if (lv === 6) { state.isAddition = false; state.currentA=r(120,900); state.currentB=r(20, state.currentA-50); }
            else if (lv === 7) { state.isAddition = true; state.currentA=r(350,850); state.currentB=r(350,850); }
            else if (lv === 8) { state.isAddition = false; state.currentA=r(400,950); state.currentB=r(250, state.currentA-50); }
            else if (lv === 9) { 
                state.isAddition = false; 
                state.currentA = r(2,9)*100; state.currentB = r(111, state.currentA-10);
            }
            else { 
                state.isAddition = Math.random() > 0.5;
                state.currentA = r(1000, 4500); state.currentB = r(500, 4500);
            }

            // ç°¡å˜ãªæ¤œè¨¼
            if (!state.isAddition && state.currentA < state.currentB) {
                [state.currentA, state.currentB] = [state.currentB, state.currentA];
            }
            if (lv === 1) {
                while ((state.currentA % 10) + (state.currentB % 10) >= 10) state.currentB = r(11,88);
            }
            if (lv === 2) {
                while ((state.currentA % 10) < (state.currentB % 10)) state.currentB = r(10, state.currentA-10);
            }

            state.mistakeCount = 0;
            state.userInput = "";
            updateInputDisplay();
            
            // å•é¡Œç¨®é¡ã®è¡¨ç¤ºæ›´æ–°
            updateProblemLabel();

            updateGameUI();
            renderGridMath();
            
            // èµ¤ä¸¸ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
            const mark = document.getElementById('correct-mark');
            mark.classList.add('hidden');
            mark.innerHTML = ''; 
            
            setMessage("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ã­", "text-slate-500");
        }

        function setNums(amin, amax, bmin, bmax) {
            state.currentA = r(amin, amax);
            state.currentB = r(bmin, bmax);
        }

        function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function updateProblemLabel() {
            const da = state.currentA.toString().length;
            const db = state.currentB.toString().length;
            const op = state.isAddition ? "ï¼‹" : "ï¼";
            document.getElementById('problem-type-label').innerText = `${da}ã‘ãŸ ${op} ${db}ã‘ãŸ`;
        }

        // --- ã‚°ãƒªãƒƒãƒ‰æç”» ---
        function renderGridMath() {
            const container = document.getElementById('mathContainer');
            container.innerHTML = '';

            const maxVal = Math.max(state.currentA, state.currentB);
            let digits = maxVal.toString().length;
            let cols = digits + 1;
            if (cols < 3) cols = 3;
            if (cols > 5) cols = 5;
            state.gridCols = cols;

            const grid = document.createElement('div');
            grid.className = 'hissan-grid';
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            grid.style.backgroundSize = `calc(100% / ${cols}) calc(100% / 3)`;
            // è¦ªè¦ç´ ã®å¹…ã«åˆã‚ã›ã¦æœ€å¤§åŒ–
            grid.style.width = '100%';

            // ã‚»ãƒ«ä½œæˆ
            const totalCells = cols * 3;
            const cells = [];
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                if (i >= cols && i < cols * 2) cell.classList.add('hissan-line');
                grid.appendChild(cell);
                cells.push(cell);
            }

            const strA = state.currentA.toString().split('');
            const strB = state.currentB.toString().split('');
            // å…¨è§’è¨˜å·ã«å¤‰æ›´
            const op = state.isAddition ? 'ï¼‹' : 'ï¼';

            // 1è¡Œç›®
            let offsetA = cols - strA.length;
            strA.forEach((num, idx) => { cells[offsetA + idx].innerText = num; });

            // 2è¡Œç›®
            let offsetB = cols + (cols - strB.length);
            if (offsetB - 1 >= cols) cells[offsetB - 1].innerText = op;
            else cells[cols].innerText = op;

            strB.forEach((num, idx) => { cells[offsetB + idx].innerText = num; });

            container.appendChild(grid);
            setTimeout(resizeCanvas, 50);
        }

        function checkAnswer() {
            if (state.userInput === '') return;
            const userAns = parseInt(state.userInput, 10);
            const correctAns = state.isAddition ? state.currentA + state.currentB : state.currentA - state.currentB;

            if (userAns === correctAns) {
                // æ­£è§£
                state.totalSolved++;
                state.solvedInLevel++;
                
                playDing();
                
                // ä¸€é‡ã®å¤§ããªèµ¤ä¸¸ã‚’æç”»ã—ã¦è¡¨ç¤º
                const mark = document.getElementById('correct-mark');
                mark.innerHTML = `
                    <svg width="250" height="250" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="8" class="circle-anim" stroke-linecap="round" />
                    </svg>
                `;
                mark.classList.remove('hidden');
                
                setMessage("ğŸ‰ ã›ã„ã‹ã„ï¼", "text-green-600 font-bold");
                
                // ãƒ¡ãƒ¢ã‚’æ¶ˆã™
                clearMemo();

                if (state.solvedInLevel >= 10) {
                    if (state.level < MAX_LEVEL) {
                        if (state.level >= state.maxUnlockedLevel) state.maxUnlockedLevel++;
                        state.level++;
                        state.solvedInLevel = 0;
                        setTimeout(() => {
                            alert(`ãŠã‚ã§ã¨ã†ï¼ ãƒ¬ãƒ™ãƒ«${state.level} ã«ä¸ŠãŒã£ãŸã‚ˆï¼`);
                            save();
                            updateTitleAndPreview();
                            generateProblem();
                        }, 1000);
                        return;
                    }
                }
                save();
                updateGameUI();
                setTimeout(generateProblem, 1200); 
                
            } else {
                // é–“é•ã„
                state.mistakeCount++;
                playBuzzer();
                
                let feedback = "ã‚‚ã†ã„ã¡ã©ï¼";
                if (Math.abs(userAns - correctAns) === 10 || Math.abs(userAns - correctAns) === 100) {
                    feedback = "ç¹°ã‚Šä¸ŠãŒã‚Šãƒ»ç¹°ã‚Šä¸‹ãŒã‚Šã‚’ãƒã‚§ãƒƒã‚¯ï¼";
                } else if (state.userInput.slice(-1) !== correctAns.toString().slice(-1)) {
                    feedback = "ä¸€ã®ä½ãŒã¡ãŒã†ã‹ã‚‚ï¼Ÿ";
                }

                setMessage(`ğŸ˜¢ ${feedback}`, "text-orange-600 font-bold");
                
                if (state.mistakeCount >= 2) {
                    const hint = state.isAddition ? "ä¸€ã®ä½ã‹ã‚‰ãŸã—ã¦ã¿ã¦ï¼" : "ä½ã‚’å€Ÿã‚Šã¦ã“ã‚ˆã†ï¼";
                    setMessage(`ğŸ’¡ ${hint}`, "text-blue-500 font-bold");
                }
            }
        }

        function setMessage(msg, cls) {
            document.getElementById('feedbackArea').innerHTML = `<p class="${cls}">${msg}</p>`;
        }

        function updateGameUI() {
            document.getElementById('display-level').innerText = state.level;
            document.getElementById('display-remain').innerText = Math.max(0, 10 - state.solvedInLevel);
        }

        // --- ãƒ¡ãƒ¢æ©Ÿèƒ½ ---
        const canvas = document.getElementById('memo-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function toggleMemo() {
            state.isMemoMode = !state.isMemoMode;
            const btn = document.getElementById('memo-btn');
            const clearBtn = document.getElementById('header-clear-btn'); // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’å–å¾—
            
            if (state.isMemoMode) {
                canvas.classList.add('active');
                if(clearBtn) clearBtn.classList.remove('hidden'); // è¡¨ç¤º
                btn.innerHTML = '<span>âœ…</span> å®Œäº†';
                btn.classList.replace('bg-blue-100', 'bg-green-100');
                btn.classList.replace('text-blue-600', 'text-green-800');
                resizeCanvas();
            } else {
                canvas.classList.remove('active');
                if(clearBtn) clearBtn.classList.add('hidden'); // éè¡¨ç¤º
                btn.innerHTML = '<span>âœï¸</span> ãƒ¡ãƒ¢';
                btn.classList.replace('bg-green-100', 'bg-blue-100');
                btn.classList.replace('text-green-800', 'text-blue-600');
            }
        }

        function resizeCanvas() {
            const wrapper = document.getElementById('hissan-wrapper');
            if(wrapper) {
                const rect = wrapper.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.6)';
            }
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDraw(e) {
            if (!state.isMemoMode) return;
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            if(e.cancelable) e.preventDefault(); 
        }
        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            if(e.cancelable) e.preventDefault();
        }
        function stopDraw() { isDrawing = false; }
        function clearMemo() { 
            if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height); 
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('touchstart', startDraw, {passive:false});
        canvas.addEventListener('touchmove', draw, {passive:false});
        window.addEventListener('touchend', stopDraw);

        load();
        window.addEventListener('resize', ()=> { if(state.isMemoMode) resizeCanvas(); });

    </script>
</body>
</html>